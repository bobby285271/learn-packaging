From 937a1a2bd067b8b3b787f3757089d972f3a39853 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Dan=20=C4=8Cerm=C3=A1k?= <dan.cermak@cgc-instruments.com>
Date: Mon, 11 Jun 2018 16:04:28 +0200
Subject: [PATCH] Add offset_ and size_ safely in
 LoaderExifJpeg::LoaderExifJpeg

offset_ can become arbitrarily large and overflows once its added to size_,
this causes all kinds of problems further in the code when offset_ is used
again.
=> Use Safe::add() to catch potential overflows
This fixes #365.

(cherry picked from commit 937a1a2bd067b8b3b787f3757089d972f3a39853)
[rcs: Backported to jessie]
---
 src/preview.cpp | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

Index: exiv2-0.25/src/preview.cpp
===================================================================
--- exiv2-0.25.orig/src/preview.cpp
+++ exiv2-0.25/src/preview.cpp
@@ -36,6 +36,7 @@ EXIV2_RCSID("@(#) $Id: preview.cpp 3777
 
 #include "preview.hpp"
 #include "futils.hpp"
+#include "safe_op.hpp"
 
 #include "image.hpp"
 #include "cr2image.hpp"
@@ -546,7 +547,8 @@ namespace {
             }
         }
 
-        if (offset_ + size_ > static_cast<uint32_t>(image_.io().size())) return;
+        if (Safe::add(offset_, size_) > static_cast<uint32_t>(image_.io().size()))
+            return;
 
         valid_ = true;
     }
