export CXXFLAGS="${CXXFLAGS} -Wno-expansion-to-defined -fPIC "
export CFLAGS="${CFLAGS} -Wno-expansion-to-defined -fPIC "

unset _JAVA_OPTIONS
unset VERSION

chmod a+x gradlew
SINGLE="--daemon"
BUILD_WEBKIT="true"

if [[ "${CROSS:-$ARCH}" != "amd64" ]]; then
    SINGLE="--no-daemon"
    BUILD_WEBKIT="false"
fi

abinfo 'Building bootstrap OpenJFX...'
cat << EOF > gradle.properties
COMPILE_WEBKIT=${BUILD_WEBKIT}
COMPILE_MEDIA=true
BUILD_JAVADOC=true
BUILD_SRC_ZIP=true
CONF=Release
COMPANY_NAME="AOSC"
EOF
./gradlew "$SINGLE" jmods

_builddir="$SRCDIR"/build
_sdkdir="${_builddir}"/sdk
install -d "$PKGDIR"/usr/share/openjfx/{lib,jmods}
install -d "$PKGDIR"/usr/share/doc/openjfx
install -m644 "${_builddir}"/jmods/* "$PKGDIR"/usr/share/openjfx/jmods/
cp -rv "${_sdkdir}"/lib/ $(pwd)/bootstrap-lib/

abinfo 'Stopping all Java processes...'
# necessary to launch Gradle workers with newly set flags
killall java || true
abinfo 'Building final OpenJFX...'
export _JAVA_OPTIONS="--module-path="$(pwd)/bootstrap-lib/
echo 'BUILD_FXPACKAGER=true' >> gradle.properties
./gradlew "$SINGLE" sdk javadoc

install -m644 "${_sdkdir}"/lib/* "$PKGDIR"/usr/share/openjfx/lib/
chmod 0777 "$PKGDIR"/usr/share/openjfx/lib/*.so
cp -arv "${_builddir}"/javadoc/* "$PKGDIR"/usr/share/doc/openjfx
